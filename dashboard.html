<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Orchestration Engine</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { 
            text-align: center; 
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
        
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-card h3 { font-size: 0.9rem; color: #888; margin-bottom: 10px; }
        .status-card .value { font-size: 2rem; font-weight: bold; }
        .status-card.healthy .value { color: #00ff88; }
        .status-card.count .value { color: #00d9ff; }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .section h2 { 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-size: 1.3rem;
        }
        .section h2 span { font-size: 1.5rem; }
        
        .workflow-card, .execution-card {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #00d9ff;
        }
        .workflow-card h4, .execution-card h4 { 
            margin-bottom: 8px; 
            color: #fff;
        }
        .workflow-card .meta, .execution-card .meta { 
            font-size: 0.85rem; 
            color: #888; 
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.active, .status-badge.completed { background: #00ff8833; color: #00ff88; }
        .status-badge.draft, .status-badge.pending { background: #ffaa0033; color: #ffaa00; }
        .status-badge.failed { background: #ff444433; color: #ff4444; }
        .status-badge.running { background: #00d9ff33; color: #00d9ff; }
        
        .steps-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        .step-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-item:last-child { border-bottom: none; }
        .step-number {
            background: #00d9ff;
            color: #000;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover { opacity: 0.9; }
        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .output-box {
            background: #000;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #00ff88;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #888; 
        }
        .error { color: #ff4444; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-btn {
            float: right;
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ Workflow Orchestration Engine</h1>
        <p class="subtitle">Your Production-Grade Backend System</p>
        
        <div class="status-cards">
            <div class="status-card healthy">
                <h3>API STATUS</h3>
                <div class="value" id="api-status">...</div>
            </div>
            <div class="status-card healthy">
                <h3>DATABASE</h3>
                <div class="value" id="db-status">...</div>
            </div>
            <div class="status-card healthy">
                <h3>REDIS QUEUE</h3>
                <div class="value" id="redis-status">...</div>
            </div>
            <div class="status-card count">
                <h3>WORKFLOWS</h3>
                <div class="value" id="workflow-count">...</div>
            </div>
            <div class="status-card count">
                <h3>EXECUTIONS</h3>
                <div class="value" id="execution-count">...</div>
            </div>
        </div>

        <div class="section">
            <h2><span>ðŸ“‹</span> Workflows <button class="refresh-btn" onclick="loadData()">â†» Refresh</button></h2>
            <div id="workflows-list"><div class="loading">Loading...</div></div>
        </div>

        <div class="section">
            <h2><span>ðŸš€</span> Recent Executions</h2>
            <div id="executions-list"><div class="loading">Loading...</div></div>
        </div>

        <div class="section">
            <h2><span>ðŸ§ª</span> Try It Out</h2>
            <button class="btn" onclick="createDemoWorkflow()">Create Demo Workflow</button>
            <button class="btn secondary" onclick="runWorkflow()">Run Latest Workflow</button>
            <div id="output-area"></div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:5001';

        async function loadData() {
            try {
                // Health check
                const health = await fetch(`${API}/health`).then(r => r.json());
                document.getElementById('api-status').textContent = health.status === 'healthy' ? 'âœ“ Online' : 'âœ— Offline';
                document.getElementById('db-status').textContent = health.database === 'healthy' ? 'âœ“ Connected' : 'âœ— Error';
                document.getElementById('redis-status').textContent = health.redis === 'healthy' ? 'âœ“ Connected' : 'âœ— Error';

                // Workflows
                const workflows = await fetch(`${API}/api/v1/workflows`).then(r => r.json());
                document.getElementById('workflow-count').textContent = workflows.count;
                
                if (workflows.workflows.length === 0) {
                    document.getElementById('workflows-list').innerHTML = '<div class="empty-state">No workflows yet. Click "Create Demo Workflow" to get started!</div>';
                } else {
                    document.getElementById('workflows-list').innerHTML = workflows.workflows.map(w => `
                        <div class="workflow-card">
                            <h4>${w.name} <span class="status-badge ${w.status}">${w.status}</span></h4>
                            <div class="meta">ID: ${w.id}</div>
                            <div class="meta">${w.description || 'No description'}</div>
                            ${w.steps.length > 0 ? `
                                <div class="steps-list">
                                    ${w.steps.map((s, i) => `
                                        <div class="step-item">
                                            <span class="step-number">${i + 1}</span>
                                            <span><strong>${s.name}</strong> â†’ ${s.task_type}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div class="meta" style="margin-top:10px;">No steps defined</div>'}
                        </div>
                    `).join('');
                }

                // Executions
                const executions = await fetch(`${API}/api/v1/executions`).then(r => r.json());
                document.getElementById('execution-count').textContent = executions.count;
                
                if (executions.executions.length === 0) {
                    document.getElementById('executions-list').innerHTML = '<div class="empty-state">No executions yet. Run a workflow to see results!</div>';
                } else {
                    document.getElementById('executions-list').innerHTML = executions.executions.slice(0, 5).map(e => `
                        <div class="execution-card">
                            <h4>Execution <span class="status-badge ${e.status}">${e.status}</span></h4>
                            <div class="meta">ID: ${e.id}</div>
                            <div class="meta">Started: ${e.started_at ? new Date(e.started_at).toLocaleString() : 'Pending'}</div>
                            ${e.status === 'completed' ? `<div class="meta" style="color:#00ff88;">âœ“ Completed at ${new Date(e.completed_at).toLocaleString()}</div>` : ''}
                            ${e.error_message ? `<div class="meta error">Error: ${e.error_message}</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (err) {
                document.getElementById('api-status').textContent = 'âœ— Offline';
                document.getElementById('api-status').style.color = '#ff4444';
                console.error(err);
            }
        }

        async function createDemoWorkflow() {
            const output = document.getElementById('output-area');
            output.innerHTML = '<div class="output-box">Creating workflow...</div>';
            
            try {
                // Create workflow
                const wf = await fetch(`${API}/api/v1/workflows`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: 'demo-' + Date.now(), 
                        description: 'Demo workflow created from dashboard' 
                    })
                }).then(r => r.json());
                
                // Add steps
                await fetch(`${API}/api/v1/workflows/${wf.id}/steps`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: 'fetch_joke', 
                        task_type: 'http_request', 
                        step_order: 0,
                        config: { url: 'https://official-joke-api.appspot.com/random_joke', method: 'GET' }
                    })
                });
                
                // Activate
                await fetch(`${API}/api/v1/workflows/${wf.id}/activate`, { method: 'POST' });
                
                output.innerHTML = `<div class="output-box">âœ“ Created workflow: ${wf.name}\nâœ“ Added step: fetch_joke\nâœ“ Activated!\n\nWorkflow ID: ${wf.id}</div>`;
                loadData();
            } catch (err) {
                output.innerHTML = `<div class="output-box error">Error: ${err.message}</div>`;
            }
        }

        async function runWorkflow() {
            const output = document.getElementById('output-area');
            output.innerHTML = '<div class="output-box">Finding workflow to run...</div>';
            
            try {
                const workflows = await fetch(`${API}/api/v1/workflows?status=active`).then(r => r.json());
                if (workflows.workflows.length === 0) {
                    output.innerHTML = '<div class="output-box">No active workflows. Create one first!</div>';
                    return;
                }
                
                const wf = workflows.workflows[0];
                output.innerHTML = `<div class="output-box">Running workflow: ${wf.name}...</div>`;
                
                const exec = await fetch(`${API}/api/v1/executions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        workflow_id: wf.id, 
                        idempotency_key: 'run-' + Date.now() 
                    })
                }).then(r => r.json());
                
                // Poll for completion
                let result = exec;
                for (let i = 0; i < 10; i++) {
                    await new Promise(r => setTimeout(r, 1000));
                    result = await fetch(`${API}/api/v1/executions/${exec.id}`).then(r => r.json());
                    if (result.status === 'completed' || result.status === 'failed') break;
                }
                
                output.innerHTML = `<div class="output-box">Workflow: ${wf.name}\nStatus: ${result.status.toUpperCase()}\n\nOutput:\n${JSON.stringify(result.output_data, null, 2)}</div>`;
                loadData();
            } catch (err) {
                output.innerHTML = `<div class="output-box error">Error: ${err.message}</div>`;
            }
        }

        // Load data on page load
        loadData();
        
        // Auto-refresh every 10 seconds
        setInterval(loadData, 10000);
    </script>
</body>
</html>
